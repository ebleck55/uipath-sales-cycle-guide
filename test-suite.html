<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UiPath Sales Guide - Optimization Test Suite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .test-pass { background-color: #dcfce7; color: #166534; }
    .test-fail { background-color: #fef2f2; color: #dc2626; }
    .test-pending { background-color: #fef3c7; color: #d97706; }
    .test-running { background-color: #dbeafe; color: #2563eb; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold mb-8 text-center">🧪 Optimization Test Suite</h1>
      
      <div class="mb-8">
        <div class="flex gap-4 items-center mb-4">
          <button id="run-all-tests" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Run All Tests
          </button>
          <button id="reset-tests" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Reset
          </button>
          <button id="open-main-app" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" onclick="window.open('index.html', '_blank')">
            Open Main App
          </button>
        </div>
        
        <div id="test-summary" class="bg-gray-100 rounded-lg p-4">
          <div class="grid grid-cols-4 gap-4 text-center">
            <div>
              <div class="text-2xl font-bold text-blue-600" id="total-tests">0</div>
              <div class="text-sm text-gray-600">Total Tests</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600" id="passed-tests">0</div>
              <div class="text-sm text-gray-600">Passed</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-red-600" id="failed-tests">0</div>
              <div class="text-sm text-gray-600">Failed</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-orange-600" id="pending-tests">0</div>
              <div class="text-sm text-gray-600">Pending</div>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-6">
        <!-- Core Functionality Tests -->
        <div class="bg-white border rounded-lg">
          <h2 class="text-xl font-semibold p-4 border-b bg-gray-50">🎯 Core Functionality Tests</h2>
          <div id="core-tests" class="p-4 space-y-2">
            <!-- Tests will be inserted here -->
          </div>
        </div>

        <!-- UI/UX Tests -->
        <div class="bg-white border rounded-lg">
          <h2 class="text-xl font-semibold p-4 border-b bg-gray-50">🎨 UI/UX Tests</h2>
          <div id="ui-tests" class="p-4 space-y-2">
            <!-- Tests will be inserted here -->
          </div>
        </div>

        <!-- Performance Tests -->
        <div class="bg-white border rounded-lg">
          <h2 class="text-xl font-semibold p-4 border-b bg-gray-50">⚡ Performance Tests</h2>
          <div id="performance-tests" class="p-4 space-y-2">
            <!-- Tests will be inserted here -->
          </div>
        </div>

        <!-- Mobile/Responsive Tests -->
        <div class="bg-white border rounded-lg">
          <h2 class="text-xl font-semibold p-4 border-b bg-gray-50">📱 Mobile/Responsive Tests</h2>
          <div id="mobile-tests" class="p-4 space-y-2">
            <!-- Tests will be inserted here -->
          </div>
        </div>

        <!-- Data Integrity Tests -->
        <div class="bg-white border rounded-lg">
          <h2 class="text-xl font-semibulent p-4 border-b bg-gray-50">💾 Data Integrity Tests</h2>
          <div id="data-tests" class="p-4 space-y-2">
            <!-- Tests will be inserted here -->
          </div>
        </div>
      </div>

      <div id="test-details" class="mt-8 bg-gray-100 rounded-lg p-4 hidden">
        <h3 class="font-semibold mb-4">Test Details</h3>
        <div id="test-details-content"></div>
      </div>
    </div>
  </div>

  <script>
    class TestSuite {
      constructor() {
        this.tests = [];
        this.results = new Map();
        this.mainAppWindow = null;
        
        this.setupTests();
        this.bindEvents();
        this.updateSummary();
      }

      setupTests() {
        // Core functionality tests
        this.addTest('core', 'page-loads', 'Main page loads without errors', async () => {
          return new Promise((resolve) => {
            this.mainAppWindow = window.open('index.html', '_blank');
            setTimeout(() => {
              try {
                if (this.mainAppWindow && !this.mainAppWindow.closed) {
                  resolve({ passed: true, message: 'Page loaded successfully' });
                } else {
                  resolve({ passed: false, message: 'Failed to open page' });
                }
              } catch (error) {
                resolve({ passed: false, message: 'Error opening page: ' + error.message });
              }
            }, 3000);
          });
        });

        this.addTest('core', 'timeline-visible', 'Timeline section is visible', async () => {
          return this.testInMainApp(() => {
            const timeline = document.getElementById('timeline-section');
            if (!timeline) return { passed: false, message: 'Timeline section not found' };
            
            const isVisible = timeline.offsetHeight > 0 && timeline.offsetWidth > 0;
            return { 
              passed: isVisible, 
              message: isVisible ? 'Timeline is visible' : 'Timeline is not visible' 
            };
          });
        });

        this.addTest('core', 'personas-section', 'Personas section is present', async () => {
          return this.testInMainApp(() => {
            const personas = document.getElementById('personas-section');
            if (!personas) return { passed: false, message: 'Personas section not found' };
            
            const personaCards = personas.querySelectorAll('.persona-card');
            return { 
              passed: personaCards.length > 0, 
              message: `Found ${personaCards.length} persona cards` 
            };
          });
        });

        this.addTest('core', 'persona-expansion', 'Persona cards can be expanded', async () => {
          return this.testInMainApp(() => {
            const personaHeaders = document.querySelectorAll('.persona-header');
            if (personaHeaders.length === 0) {
              return { passed: false, message: 'No persona headers found' };
            }

            // Try to click first persona
            try {
              const firstPersona = personaHeaders[0];
              firstPersona.click();
              
              // Wait a bit for animation
              setTimeout(() => {
                const content = document.querySelector('[data-persona-content="0"]');
                const isExpanded = content && !content.classList.contains('hidden');
                return { 
                  passed: isExpanded, 
                  message: isExpanded ? 'Persona expanded successfully' : 'Persona did not expand' 
                };
              }, 500);
            } catch (error) {
              return { passed: false, message: 'Error clicking persona: ' + error.message };
            }
          });
        });

        this.addTest('core', 'admin-access', 'Admin panel is accessible', async () => {
          return this.testInMainApp(() => {
            const adminLink = document.querySelector('a[href*="admin"]');
            return { 
              passed: !!adminLink, 
              message: adminLink ? 'Admin link found' : 'Admin link not found' 
            };
          });
        });

        // UI/UX Tests
        this.addTest('ui', 'responsive-design', 'Layout is responsive', async () => {
          return this.testInMainApp(() => {
            const viewport = window.innerWidth;
            const mobileElements = document.querySelectorAll('.md\\:grid-cols-2, .lg\\:grid-cols-2');
            
            return { 
              passed: mobileElements.length > 0, 
              message: `Responsive classes found for ${viewport}px viewport` 
            };
          });
        });

        this.addTest('ui', 'color-scheme', 'Color scheme is consistent', async () => {
          return this.testInMainApp(() => {
            const blueElements = document.querySelectorAll('[class*="blue-"]');
            const orangeElements = document.querySelectorAll('[class*="orange-"]');
            
            return { 
              passed: blueElements.length > 0 && orangeElements.length > 0, 
              message: `Found ${blueElements.length} blue and ${orangeElements.length} orange elements` 
            };
          });
        });

        this.addTest('ui', 'accessibility-labels', 'Accessibility labels are present', async () => {
          return this.testInMainApp(() => {
            const ariaLabels = document.querySelectorAll('[aria-label]');
            const altTexts = document.querySelectorAll('img[alt]');
            
            return { 
              passed: ariaLabels.length > 0, 
              message: `Found ${ariaLabels.length} aria-labels and ${altTexts.length} alt texts` 
            };
          });
        });

        // Performance Tests
        this.addTest('performance', 'load-time', 'Page loads within acceptable time', async () => {
          return this.testInMainApp(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            if (!perfData) return { passed: false, message: 'No performance data available' };
            
            const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
            const acceptable = loadTime < 3000; // 3 seconds
            
            return { 
              passed: acceptable, 
              message: `Load time: ${loadTime.toFixed(0)}ms` 
            };
          });
        });

        this.addTest('performance', 'optimization-modules', 'Optimization modules are loaded', async () => {
          return this.testInMainApp(() => {
            const hasPerformanceManager = !!window.PerformanceManager;
            const hasDataManager = !!window.DataManager;
            const hasAnalytics = !!window.AnalyticsManager;
            const hasUXEnhancer = !!window.UXEnhancer;
            
            const loadedCount = [hasPerformanceManager, hasDataManager, hasAnalytics, hasUXEnhancer].filter(Boolean).length;
            
            return { 
              passed: loadedCount >= 3, 
              message: `${loadedCount}/4 optimization modules loaded` 
            };
          });
        });

        // Mobile Tests
        this.addTest('mobile', 'touch-targets', 'Touch targets are adequate size', async () => {
          return this.testInMainApp(() => {
            const clickableElements = document.querySelectorAll('button, .persona-header, .timeline-dot');
            let adequateSize = 0;
            
            clickableElements.forEach(el => {
              const rect = el.getBoundingClientRect();
              if (rect.width >= 44 && rect.height >= 44) {
                adequateSize++;
              }
            });
            
            const percentage = (adequateSize / clickableElements.length) * 100;
            
            return { 
              passed: percentage >= 80, 
              message: `${adequateSize}/${clickableElements.length} elements (${percentage.toFixed(1)}%) meet touch target size` 
            };
          });
        });

        // Data Tests
        this.addTest('data', 'personas-data', 'Personas data is loaded correctly', async () => {
          return this.testInMainApp(() => {
            const hasBasicData = !!window.SALES_CYCLE_DATA?.personas;
            const hasEnhancedData = !!window.TimelineApp?.adminPersonas;
            
            return { 
              passed: hasBasicData || hasEnhancedData, 
              message: `Basic data: ${hasBasicData}, Enhanced data: ${hasEnhancedData}` 
            };
          });
        });

        this.addTest('data', 'stage-data', 'Stage data is available', async () => {
          return this.testInMainApp(() => {
            const stages = window.SALES_CYCLE_DATA?.stages;
            if (!stages) return { passed: false, message: 'No stages data found' };
            
            return { 
              passed: stages.length > 0, 
              message: `Found ${stages.length} stages` 
            };
          });
        });
      }

      addTest(category, id, description, testFunction) {
        this.tests.push({
          id,
          category,
          description,
          testFunction,
          status: 'pending'
        });
      }

      async testInMainApp(testFunction) {
        if (!this.mainAppWindow || this.mainAppWindow.closed) {
          return { passed: false, message: 'Main app window not available' };
        }

        try {
          return this.mainAppWindow.eval(`(${testFunction.toString()})()`);
        } catch (error) {
          return { passed: false, message: 'Error running test: ' + error.message };
        }
      }

      bindEvents() {
        document.getElementById('run-all-tests').addEventListener('click', () => {
          this.runAllTests();
        });

        document.getElementById('reset-tests').addEventListener('click', () => {
          this.resetTests();
        });
      }

      async runAllTests() {
        console.log('🧪 Starting test suite...');
        
        for (const test of this.tests) {
          await this.runTest(test);
          await this.delay(500); // Small delay between tests
        }
        
        this.updateSummary();
        console.log('✅ Test suite completed');
      }

      async runTest(test) {
        console.log(`Running test: ${test.description}`);
        
        test.status = 'running';
        this.renderTest(test);
        
        try {
          const result = await test.testFunction();
          test.result = result;
          test.status = result.passed ? 'passed' : 'failed';
        } catch (error) {
          test.result = { passed: false, message: error.message };
          test.status = 'failed';
        }
        
        this.renderTest(test);
      }

      renderTest(test) {
        const container = document.getElementById(`${test.category}-tests`);
        if (!container) return;

        let testElement = container.querySelector(`[data-test-id="${test.id}"]`);
        if (!testElement) {
          testElement = document.createElement('div');
          testElement.setAttribute('data-test-id', test.id);
          container.appendChild(testElement);
        }

        const statusClass = {
          pending: 'test-pending',
          running: 'test-running',
          passed: 'test-pass',
          failed: 'test-fail'
        }[test.status] || 'test-pending';

        const statusIcon = {
          pending: '⏳',
          running: '🔄',
          passed: '✅',
          failed: '❌'
        }[test.status] || '⏳';

        testElement.className = `p-3 rounded-lg ${statusClass} flex justify-between items-center`;
        testElement.innerHTML = `
          <div>
            <div class="font-medium">${statusIcon} ${test.description}</div>
            ${test.result ? `<div class="text-sm mt-1">${test.result.message}</div>` : ''}
          </div>
          <div class="text-sm font-mono">${test.status.toUpperCase()}</div>
        `;
      }

      renderAllTests() {
        // Group tests by category and render them
        const categories = ['core', 'ui', 'performance', 'mobile', 'data'];
        
        categories.forEach(category => {
          const categoryTests = this.tests.filter(t => t.category === category);
          categoryTests.forEach(test => this.renderTest(test));
        });
      }

      resetTests() {
        this.tests.forEach(test => {
          test.status = 'pending';
          test.result = null;
        });
        
        this.renderAllTests();
        this.updateSummary();
      }

      updateSummary() {
        const total = this.tests.length;
        const passed = this.tests.filter(t => t.status === 'passed').length;
        const failed = this.tests.filter(t => t.status === 'failed').length;
        const pending = this.tests.filter(t => t.status === 'pending').length;

        document.getElementById('total-tests').textContent = total;
        document.getElementById('passed-tests').textContent = passed;
        document.getElementById('failed-tests').textContent = failed;
        document.getElementById('pending-tests').textContent = pending;
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // Initialize test suite
    const testSuite = new TestSuite();
    testSuite.renderAllTests();
  </script>
</body>
</html>