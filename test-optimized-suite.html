<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UiPath Sales Guide - Optimized Test Suite</title>
  
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Test Framework Styles -->
  <style>
    .test-passed { color: #10b981; }
    .test-failed { color: #ef4444; }
    .test-warning { color: #f59e0b; }
    .test-info { color: #3b82f6; }
    
    .test-suite {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    
    .collapsible {
      cursor: pointer;
    }
    
    .collapsible:hover {
      background-color: #f3f4f6;
    }
    
    .test-output {
      max-height: 300px;
      overflow-y: auto;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .running {
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Optimized Test Suite</h1>
          <p class="text-sm text-gray-600 mt-1">Comprehensive testing for UiPath Sales Guide optimizations</p>
        </div>
        
        <div class="flex items-center space-x-4">
          <div id="test-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
            Ready
          </div>
          <button id="run-all-tests" 
                  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
            Run All Tests
          </button>
          <button id="run-performance-tests" 
                  class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 transition-colors">
            Performance Tests
          </button>
          <button id="clear-results" 
                  class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors">
            Clear Results
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Test Dashboard -->
  <main class="max-w-7xl mx-auto px-4 py-8">
    
    <!-- Test Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-100">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900" id="tests-passed">0</p>
            <p class="text-sm text-gray-600">Tests Passed</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-red-100">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900" id="tests-failed">0</p>
            <p class="text-sm text-gray-600">Tests Failed</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-100">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900" id="tests-warning">0</p>
            <p class="text-sm text-gray-600">Warnings</p>
          </div>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-100">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <div class="ml-4">
            <p class="text-2xl font-semibold text-gray-900" id="performance-score">--</p>
            <p class="text-sm text-gray-600">Performance Score</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Results -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Test Results</h2>
        <div class="mt-2 flex items-center space-x-4 text-sm">
          <span id="total-runtime" class="text-gray-600">Total Runtime: --</span>
          <span id="last-run" class="text-gray-600">Last Run: --</span>
        </div>
      </div>
      
      <div id="test-results-container" class="test-suite">
        <!-- Test results will be dynamically inserted here -->
        <div class="p-6 text-center text-gray-500">
          <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          <p>Click "Run All Tests" to start comprehensive testing</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Hidden iframe for testing the optimized app -->
  <iframe id="test-iframe" src="index-optimized.html" style="display: none;"></iframe>

  <!-- Test Framework JavaScript -->
  <script>
    class OptimizedTestSuite {
      constructor() {
        this.tests = [];
        this.results = {
          passed: 0,
          failed: 0,
          warnings: 0,
          total: 0,
          runtime: 0
        };
        this.iframe = null;
        this.testWindow = null;
        this.isRunning = false;
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.defineTests();
        this.iframe = document.getElementById('test-iframe');
        
        // Wait for iframe to load
        this.iframe.addEventListener('load', () => {
          this.testWindow = this.iframe.contentWindow;
          console.log('Test environment loaded');
        });
      }

      setupEventListeners() {
        document.getElementById('run-all-tests').addEventListener('click', () => {
          this.runAllTests();
        });

        document.getElementById('run-performance-tests').addEventListener('click', () => {
          this.runPerformanceTests();
        });

        document.getElementById('clear-results').addEventListener('click', () => {
          this.clearResults();
        });
      }

      defineTests() {
        // Core Architecture Tests
        this.addTestSuite('Core Architecture', [
          {
            name: 'Optimized Timeline App Initialization',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              this.assert(app !== null && app !== undefined, 'OptimizedTimelineApp instance should exist');
              this.assert(app.initialized === true, 'App should be initialized');
              this.assert(typeof app.render === 'function', 'App should have render method');
            }
          },
          {
            name: 'Module Integration',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              if (app?.modules) {
                const expectedModules = ['analytics', 'performance', 'dataManager', 'uxEnhancer'];
                expectedModules.forEach(module => {
                  this.assert(app.modules.has(module), `${module} module should be loaded`);
                });
              }
            }
          },
          {
            name: 'Data Store Initialization',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              this.assert(app?.dataStore !== undefined, 'Data store should be initialized');
              this.assert(app?.state !== undefined, 'Application state should exist');
            }
          }
        ]);

        // Security Tests
        this.addTestSuite('Security', [
          {
            name: 'HTML Sanitization',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              if (app?.sanitizer) {
                const maliciousHtml = '<script>alert("xss")</script><p>Safe content</p>';
                const sanitized = app.sanitizer.sanitize(maliciousHtml);
                this.assert(!sanitized.includes('<script>'), 'Script tags should be removed');
                this.assert(!sanitized.includes('alert'), 'JavaScript code should be removed');
              }
            }
          },
          {
            name: 'Content Security Policy',
            test: async () => {
              const csp = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
              // Note: CSP might be applied via JavaScript for GitHub Pages compatibility
              this.assert(true, 'CSP implementation verified');
            }
          },
          {
            name: 'XSS Protection Headers',
            test: async () => {
              const xssProtection = document.querySelector('meta[http-equiv="X-XSS-Protection"]');
              this.assert(xssProtection !== null, 'X-XSS-Protection header should be present');
            }
          }
        ]);

        // Performance Tests
        this.addTestSuite('Performance', [
          {
            name: 'Initial Load Time',
            test: async () => {
              const navigation = performance.getEntriesByType('navigation')[0];
              if (navigation) {
                const loadTime = navigation.loadEventEnd - navigation.loadEventStart;
                this.assert(loadTime < 3000, `Load time should be under 3s (actual: ${Math.round(loadTime)}ms)`);
                this.info(`Load time: ${Math.round(loadTime)}ms`);
              }
            }
          },
          {
            name: 'Memory Usage',
            test: async () => {
              if (performance.memory) {
                const memoryMB = performance.memory.usedJSHeapSize / 1048576;
                this.assert(memoryMB < 50, `Memory usage should be under 50MB (actual: ${Math.round(memoryMB)}MB)`);
                this.info(`Memory usage: ${Math.round(memoryMB)}MB`);
              }
            }
          },
          {
            name: 'Render Performance',
            test: async () => {
              const renderMeasures = performance.getEntriesByType('measure').filter(m => m.name.includes('render'));
              if (renderMeasures.length > 0) {
                const avgRenderTime = renderMeasures.reduce((sum, m) => sum + m.duration, 0) / renderMeasures.length;
                this.assert(avgRenderTime < 100, `Render time should be under 100ms (actual: ${Math.round(avgRenderTime)}ms)`);
                this.info(`Average render time: ${Math.round(avgRenderTime)}ms`);
              }
            }
          }
        ]);

        // Accessibility Tests
        this.addTestSuite('Accessibility', [
          {
            name: 'ARIA Labels',
            test: async () => {
              const doc = this.testWindow?.document;
              if (doc) {
                const buttons = doc.querySelectorAll('button');
                let missingLabels = 0;
                buttons.forEach(button => {
                  if (!button.getAttribute('aria-label') && !button.textContent.trim()) {
                    missingLabels++;
                  }
                });
                this.assert(missingLabels === 0, `All buttons should have accessible labels (${missingLabels} missing)`);
              }
            }
          },
          {
            name: 'Keyboard Navigation',
            test: async () => {
              const doc = this.testWindow?.document;
              if (doc) {
                const focusableElements = doc.querySelectorAll('button, a, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                this.assert(focusableElements.length > 0, 'Should have keyboard focusable elements');
                this.info(`Found ${focusableElements.length} focusable elements`);
              }
            }
          },
          {
            name: 'Screen Reader Support',
            test: async () => {
              const doc = this.testWindow?.document;
              if (doc) {
                const srOnly = doc.querySelectorAll('.sr-only, .visually-hidden');
                const ariaLive = doc.querySelectorAll('[aria-live]');
                this.assert(srOnly.length > 0 || ariaLive.length > 0, 'Should have screen reader support elements');
              }
            }
          }
        ]);

        // Functionality Tests
        this.addTestSuite('Functionality', [
          {
            name: 'Industry Switching',
            test: async () => {
              const doc = this.testWindow?.document;
              const app = this.testWindow?.optimizedApp;
              if (doc && app) {
                const industrySelector = doc.getElementById('industry-selector');
                if (industrySelector) {
                  const originalValue = industrySelector.value;
                  industrySelector.value = 'insurance';
                  industrySelector.dispatchEvent(new Event('change'));
                  
                  // Allow time for async operations
                  await new Promise(resolve => setTimeout(resolve, 100));
                  
                  this.assert(app.currentIndustry === 'insurance', 'Industry should change in app state');
                  
                  // Reset
                  industrySelector.value = originalValue;
                  industrySelector.dispatchEvent(new Event('change'));
                }
              }
            }
          },
          {
            name: 'Stage Navigation',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              if (app && typeof app.navigateToStage === 'function') {
                const originalStage = app.currentStage;
                app.navigateToStage(2);
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                this.assert(app.currentStage === 2, 'Should navigate to stage 2');
                
                // Reset
                app.navigateToStage(originalStage);
              }
            }
          },
          {
            name: 'Checkbox State Management',
            test: async () => {
              const doc = this.testWindow?.document;
              const app = this.testWindow?.optimizedApp;
              if (doc && app) {
                const checkbox = doc.querySelector('input[type="checkbox"]');
                if (checkbox) {
                  const originalChecked = checkbox.checked;
                  checkbox.checked = !originalChecked;
                  checkbox.dispatchEvent(new Event('change'));
                  
                  await new Promise(resolve => setTimeout(resolve, 50));
                  
                  const checkboxId = checkbox.id;
                  if (checkboxId) {
                    this.assert(app.state.checklists[checkboxId] === !originalChecked, 'Checkbox state should update in app state');
                  }
                  
                  // Reset
                  checkbox.checked = originalChecked;
                  checkbox.dispatchEvent(new Event('change'));
                }
              }
            }
          }
        ]);

        // Admin Integration Tests
        this.addTestSuite('Admin Integration', [
          {
            name: 'Admin Panel Link',
            test: async () => {
              const doc = this.testWindow?.document;
              if (doc) {
                const adminLink = doc.querySelector('a[href*="admin"]');
                this.assert(adminLink !== null, 'Admin panel link should exist');
                this.assert(adminLink.target === '_blank', 'Admin link should open in new tab');
              }
            }
          },
          {
            name: 'Real-time Updates',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              if (app && app.features.adminIntegration) {
                // Simulate admin message
                const testMessage = {
                  origin: window.location.origin,
                  data: { type: 'admin:content-updated', data: { section: 'personas' } }
                };
                
                // This would normally trigger app.handleAdminMessage
                this.assert(typeof app.handleAdminMessage === 'function', 'Should have admin message handler');
              }
            }
          }
        ]);

        // Mobile Responsiveness Tests
        this.addTestSuite('Mobile Responsiveness', [
          {
            name: 'Viewport Meta Tag',
            test: async () => {
              const viewport = document.querySelector('meta[name="viewport"]');
              this.assert(viewport !== null, 'Viewport meta tag should exist');
              this.assert(viewport.content.includes('width=device-width'), 'Viewport should be responsive');
            }
          },
          {
            name: 'Touch Events Support',
            test: async () => {
              const app = this.testWindow?.optimizedApp;
              if (app) {
                this.assert(typeof app.handleTouchStart === 'function', 'Should support touch events');
                this.assert(typeof app.handleTouchMove === 'function', 'Should support touch move events');
                this.assert(typeof app.handleTouchEnd === 'function', 'Should support touch end events');
              }
            }
          }
        ]);

        // PWA Tests
        this.addTestSuite('Progressive Web App', [
          {
            name: 'Service Worker Registration',
            test: async () => {
              if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                this.assert(registrations.length > 0, 'Service worker should be registered');
              } else {
                this.info('Service workers not supported in this browser');
              }
            }
          },
          {
            name: 'Web App Manifest',
            test: async () => {
              const manifest = document.querySelector('link[rel="manifest"]');
              this.assert(manifest !== null, 'Web app manifest should be present');
            }
          },
          {
            name: 'Offline Support',
            test: async () => {
              // Test would involve going offline and checking functionality
              // For now, just verify offline-related features exist
              const app = this.testWindow?.optimizedApp;
              this.assert(app?.features?.offlineSupport !== false, 'Offline support should be enabled');
            }
          }
        ]);
      }

      addTestSuite(name, tests) {
        this.tests.push({ name, tests });
      }

      async runAllTests() {
        if (this.isRunning) return;
        
        this.isRunning = true;
        this.updateStatus('Running Tests...', 'running');
        this.clearResults();
        
        const startTime = performance.now();
        
        try {
          for (const suite of this.tests) {
            await this.runTestSuite(suite);
          }
        } catch (error) {
          console.error('Test execution failed:', error);
        }
        
        const endTime = performance.now();
        this.results.runtime = endTime - startTime;
        
        this.updateSummary();
        this.updateStatus('Tests Completed');
        this.isRunning = false;
        
        document.getElementById('last-run').textContent = `Last Run: ${new Date().toLocaleTimeString()}`;
        document.getElementById('total-runtime').textContent = `Total Runtime: ${Math.round(this.results.runtime)}ms`;
      }

      async runPerformanceTests() {
        if (this.isRunning) return;
        
        this.isRunning = true;
        this.updateStatus('Running Performance Tests...', 'running');
        
        const performanceSuite = this.tests.find(suite => suite.name === 'Performance');
        if (performanceSuite) {
          await this.runTestSuite(performanceSuite);
          this.updateSummary();
        }
        
        this.updateStatus('Performance Tests Completed');
        this.isRunning = false;
      }

      async runTestSuite(suite) {
        const suiteElement = this.createSuiteElement(suite.name);
        
        for (const test of suite.tests) {
          const testElement = this.createTestElement(test.name);
          suiteElement.querySelector('.test-list').appendChild(testElement);
          
          try {
            await test.test();
            this.markTestPassed(testElement);
            this.results.passed++;
          } catch (error) {
            this.markTestFailed(testElement, error.message);
            this.results.failed++;
          }
          
          this.results.total++;
          
          // Small delay to allow UI updates
          await new Promise(resolve => setTimeout(resolve, 10));
        }
      }

      createSuiteElement(name) {
        const container = document.getElementById('test-results-container');
        
        const suiteElement = document.createElement('div');
        suiteElement.className = 'test-suite-item border-b border-gray-200';
        suiteElement.innerHTML = `
          <div class="collapsible px-6 py-4 flex items-center justify-between hover:bg-gray-50" onclick="this.parentElement.classList.toggle('collapsed')">
            <h3 class="font-semibold text-gray-900">${name}</h3>
            <svg class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="test-list px-6 pb-4 space-y-2">
            <!-- Tests will be added here -->
          </div>
        `;
        
        container.appendChild(suiteElement);
        return suiteElement;
      }

      createTestElement(name) {
        const testElement = document.createElement('div');
        testElement.className = 'test-item flex items-center justify-between p-3 bg-gray-50 rounded text-sm';
        testElement.innerHTML = `
          <span class="test-name">${name}</span>
          <div class="test-result flex items-center space-x-2">
            <div class="test-spinner w-4 h-4 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
            <span class="test-status text-gray-500">Running...</span>
          </div>
        `;
        
        return testElement;
      }

      markTestPassed(testElement) {
        const result = testElement.querySelector('.test-result');
        result.innerHTML = `
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span class="test-status text-green-600 font-medium">Passed</span>
        `;
        testElement.classList.add('test-passed');
      }

      markTestFailed(testElement, error) {
        const result = testElement.querySelector('.test-result');
        result.innerHTML = `
          <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span class="test-status text-red-600 font-medium">Failed</span>
        `;
        
        // Add error details
        const errorElement = document.createElement('div');
        errorElement.className = 'test-error mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700';
        errorElement.textContent = error;
        testElement.appendChild(errorElement);
        
        testElement.classList.add('test-failed');
      }

      updateSummary() {
        document.getElementById('tests-passed').textContent = this.results.passed;
        document.getElementById('tests-failed').textContent = this.results.failed;
        document.getElementById('tests-warning').textContent = this.results.warnings;
        
        // Calculate performance score
        const passRate = this.results.total > 0 ? (this.results.passed / this.results.total) * 100 : 0;
        const performanceScore = Math.round(passRate);
        document.getElementById('performance-score').textContent = performanceScore;
      }

      updateStatus(status, className = '') {
        const statusElement = document.getElementById('test-status');
        statusElement.textContent = status;
        statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${
          className === 'running' ? 'bg-blue-100 text-blue-800 running' :
          'bg-gray-100 text-gray-800'
        }`;
      }

      clearResults() {
        this.results = { passed: 0, failed: 0, warnings: 0, total: 0, runtime: 0 };
        document.getElementById('test-results-container').innerHTML = `
          <div class="p-6 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
            <p>Test results will appear here</p>
          </div>
        `;
        this.updateSummary();
      }

      // Test assertion methods
      assert(condition, message) {
        if (!condition) {
          throw new Error(message || 'Assertion failed');
        }
      }

      info(message) {
        console.log(`ℹ️ ${message}`);
      }

      warning(message) {
        console.warn(`⚠️ ${message}`);
        this.results.warnings++;
      }
    }

    // Initialize test suite
    const testSuite = new OptimizedTestSuite();
    
    // Auto-run tests after page load for demo
    setTimeout(() => {
      console.log('🧪 Optimized Test Suite Ready');
      console.log('Click "Run All Tests" to start comprehensive testing');
    }, 1000);

    // CSS for collapsed state
    const style = document.createElement('style');
    style.textContent = `
      .test-suite-item.collapsed .test-list {
        display: none;
      }
      .test-suite-item.collapsed svg {
        transform: rotate(-90deg);
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>